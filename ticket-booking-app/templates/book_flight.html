{% extends "base.html" %}

{% block title %}Бронирование рейса{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Информация о рейсе -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-plane"></i> Информация о рейсе</h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h4>{{ flight.departure_airport.city }} → {{ flight.arrival_airport.city }}</h4>
                        <span class="badge bg-secondary">{{ flight.flight_number }}</span>
                    </div>
                    
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <small class="text-muted">Вылет</small>
                            <div class="h5">{{ flight.departure_time.strftime('%H:%M') }}</div>
                            <small>{{ flight.departure_time.strftime('%d.%m.%Y') }}</small>
                            <div class="small text-muted">{{ flight.departure_airport.name }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Прилет</small>
                            <div class="h5">{{ flight.arrival_time.strftime('%H:%M') }}</div>
                            <small>{{ flight.arrival_time.strftime('%d.%m.%Y') }}</small>
                            <div class="small text-muted">{{ flight.arrival_airport.name }}</div>
                        </div>
                    </div>
                    
                    <div class="flight-line text-center">
                        <i class="fas fa-plane"></i>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <small class="text-muted">Авиакомпания:</small>
                            <div>{{ flight.airline.name }}</div>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-6">
                            <small class="text-muted">Самолет:</small>
                            <div>{{ flight.aircraft_type or 'Не указан' }}</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Свободных мест:</small>
                            <div class="fw-bold">{{ flight.available_seats }}</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Цены -->
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-tag"></i> Цены</h6>
                </div>
                <div class="card-body">
                    <div class="price-item mb-2">
                        <span class="badge bg-success">Эконом</span>
                        <div class="h6 text-success" data-base-price="{{ flight.economy_price }}">{{ "%.0f"|format(flight.economy_price) }} ₽</div>
                    </div>
                    {% if flight.business_price %}
                    <div class="price-item mb-2">
                        <span class="badge bg-warning">Бизнес</span>
                        <div class="h6 text-warning" data-business-price="{{ flight.business_price }}">{{ "%.0f"|format(flight.business_price) }} ₽</div>
                    </div>
                    {% endif %}
                    {% if flight.first_class_price %}
                    <div class="price-item">
                        <span class="badge bg-info">Первый</span>
                        <div class="h6 text-info" data-first-price="{{ flight.first_class_price }}">{{ "%.0f"|format(flight.first_class_price) }} ₽</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Форма бронирования -->
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-ticket-alt"></i> Оформление бронирования</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <!-- Информация о пассажире -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-user"></i> Информация о пассажире</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.passenger_first_name.label(class="form-label") }}
                                            {{ form.passenger_first_name(class="form-control") }}
                                            {% if form.passenger_first_name.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.passenger_first_name.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.passenger_last_name.label(class="form-label") }}
                                            {{ form.passenger_last_name(class="form-control") }}
                                            {% if form.passenger_last_name.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.passenger_last_name.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.passenger_email.label(class="form-label") }}
                                            {{ form.passenger_email(class="form-control") }}
                                            {% if form.passenger_email.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.passenger_email.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            {{ form.passenger_phone.label(class="form-label") }}
                                            {{ form.passenger_phone(class="form-control", placeholder="+7 (900) 123-45-67") }}
                                            {% if form.passenger_phone.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.passenger_phone.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Параметры билета -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-cog"></i> Параметры билета</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ form.seat_class.label(class="form-label") }}
                                            {{ form.seat_class(class="form-select") }}
                                            {% if form.seat_class.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.seat_class.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ form.baggage_count.label(class="form-label") }}
                                            {{ form.baggage_count(class="form-control", min="0", max="5") }}
                                            {% if form.baggage_count.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.baggage_count.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            {{ form.meal_preference.label(class="form-label") }}
                                            {{ form.meal_preference(class="form-select") }}
                                            {% if form.meal_preference.errors %}
                                                <div class="text-danger small">
                                                    {% for error in form.meal_preference.errors %}{{ error }}{% endfor %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    {{ form.special_requests.label(class="form-label") }}
                                    {{ form.special_requests(class="form-control", rows="3", placeholder="Укажите особые пожелания или требования...") }}
                                    {% if form.special_requests.errors %}
                                        <div class="text-danger small">
                                            {% for error in form.special_requests.errors %}{{ error }}{% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Итоговая цена -->
                        <div class="card mb-4">
                            <div class="card-body bg-light">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h5 class="mb-0">Итого к оплате:</h5>
                                        <small class="text-muted">Цена за 1 пассажира, включая все сборы</small>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="h3 text-success price-display">{{ "%.0f"|format(flight.economy_price) }} ₽</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Кнопки -->
                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('search_flights') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left"></i> Назад к поиску
                            </a>
                            {{ form.submit(class="btn btn-primary btn-lg") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Автозаполнение данных пассажира
    {% if current_user.is_authenticated %}
    const firstNameInput = document.querySelector('input[name="passenger_first_name"]');
    const lastNameInput = document.querySelector('input[name="passenger_last_name"]');
    const emailInput = document.querySelector('input[name="passenger_email"]');
    
    if (firstNameInput && !firstNameInput.value) {
        firstNameInput.value = '{{ current_user.first_name }}';
    }
    if (lastNameInput && !lastNameInput.value) {
        lastNameInput.value = '{{ current_user.last_name }}';
    }
    if (emailInput && !emailInput.value) {
        emailInput.value = '{{ current_user.email }}';
    }
    {% endif %}
    
    // Обновление цены при изменении класса
    const seatClassSelect = document.querySelector('select[name="seat_class"]');
    const priceDisplay = document.querySelector('.price-display');
    
    if (seatClassSelect && priceDisplay) {
        seatClassSelect.addEventListener('change', updatePrice);
        updatePrice(); // Инициальный расчет
    }
    
    function updatePrice() {
        const seatClass = seatClassSelect.value;
        const economyPrice = {{ flight.economy_price }};
        const businessPrice = {{ flight.business_price or (flight.economy_price * 2) }};
        const firstPrice = {{ flight.first_class_price or (flight.economy_price * 3) }};
        
        let finalPrice = economyPrice;
        
        switch(seatClass) {
            case 'business':
                finalPrice = businessPrice;
                break;
            case 'first':
                finalPrice = firstPrice;
                break;
            default:
                finalPrice = economyPrice;
        }
        
        priceDisplay.textContent = Math.round(finalPrice) + ' ₽';
    }
    
    // Валидация email пассажира в реальном времени
    const passengerEmailInput = document.querySelector('input[name="passenger_email"]');
    if (passengerEmailInput) {
        passengerEmailInput.addEventListener('input', function() {
            const email = this.value;
            const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            
            if (email && !emailRegex.test(email)) {
                this.setCustomValidity('Введите корректный email адрес');
                this.classList.add('is-invalid');
            } else {
                this.setCustomValidity('');
                this.classList.remove('is-invalid');
            }
        });
    }
});
</script>
{% endblock %}