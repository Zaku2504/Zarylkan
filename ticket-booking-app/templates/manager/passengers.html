{% extends "manager/base.html" %}

{% block title %}Пассажиры - Панель менеджера{% endblock %}

{% block manager_content %}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users"></i> Пассажиры</h2>
                <select class="form-select" id="flightFilter" onchange="filterByFlight()" style="max-width: 400px;">
                    <option value="">Все рейсы</option>
                    {% for flight in flights %}
                    <option value="{{ flight.id }}" {{ 'selected' if request.args.get('flight') == flight.id|string }}>
                        {{ flight.flight_number }} - {{ flight.departure_airport.city }} → {{ flight.arrival_airport.city }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            {% if passengers %}
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Всего пассажиров: {{ passengers|length }}</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Код бронирования</th>
                                        <th>Пассажир</th>
                                        <th>Рейс</th>
                                        <th>Маршрут</th>
                                        <th>Класс</th>
                                        <th>Место</th>
                                        <th>Цена</th>
                                        <th>Статус</th>
                                        <th>Действия</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for booking in passengers %}
                                    <tr>
                                        <td>
                                            <strong>{{ booking.booking_reference }}</strong>
                                            <div class="small text-muted">{{ booking.booking_date.strftime('%d.%m.%Y %H:%M') }}</div>
                                        </td>
                                        <td>
                                            <div>{{ booking.passenger_first_name }} {{ booking.passenger_last_name }}</div>
                                            <small class="text-muted">{{ booking.passenger_email }}</small>
                                        </td>
                                        <td>
                                            <strong>{{ booking.flight.flight_number }}</strong>
                                            <div class="small text-muted">{{ booking.flight.airline.name }}</div>
                                        </td>
                                        <td>
                                            <div>{{ booking.flight.departure_airport.city }} → {{ booking.flight.arrival_airport.city }}</div>
                                            <small class="text-muted">{{ booking.flight.departure_time.strftime('%d.%m.%Y %H:%M') }}</small>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if booking.seat_class == 'economy' else 'warning' if booking.seat_class == 'business' else 'info' }}">
                                                {{ booking.seat_class }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if booking.seat_number %}
                                                {{ booking.seat_number }}
                                            {% else %}
                                                <span class="text-muted">Не назначено</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <strong>{{ "%.0f"|format(booking.price_paid) }} ₽</strong>
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'success' if booking.status == 'confirmed' else 'warning' if booking.status == 'checked_in' else 'danger' }}">
                                                {{ booking.status }}
                                            </span>
                                        </td>
                                        <td>
                                            <button class="btn btn-outline-primary btn-sm" 
                                                    onclick="viewBookingDetails({{ booking.id }})" 
                                                    title="Подробности">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="card bg-light">
                        <div class="card-body py-5">
                            <i class="fas fa-users fa-3x text-muted mb-4"></i>
                            <h4 class="text-muted">Пассажиры не найдены</h4>
                            <p class="text-muted">На выбранные рейсы пока нет бронирований</p>
                        </div>
                    </div>
                </div>
            {% endif %}

<!-- Модальное окно для деталей бронирования -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-info-circle"></i> Детали бронирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetailsContent">
                <!-- Содержимое загружается через JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Закрыть
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function filterByFlight() {
    const flightId = document.getElementById('flightFilter').value;
    const url = new URL(window.location);
    
    if (flightId) {
        url.searchParams.set('flight', flightId);
    } else {
        url.searchParams.delete('flight');
    }
    
    window.location.href = url.toString();
}

function viewBookingDetails(bookingId) {
    // Показываем загрузку
    const content = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p class="mt-2">Загружаем детали бронирования...</p>
        </div>
    `;
    
    document.getElementById('bookingDetailsContent').innerHTML = content;
    
    // Показываем модальное окно
    const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
    modal.show();
    
    // AJAX запрос для получения деталей
    fetch(`/manager/api/booking/${bookingId}/details`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('bookingDetailsContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Информация о пассажире</h6>
                        <p><strong>Имя:</strong> ${data.passenger_first_name} ${data.passenger_last_name}</p>
                        <p><strong>Email:</strong> ${data.passenger_email || 'Не указан'}</p>
                        <p><strong>Телефон:</strong> ${data.passenger_phone || 'Не указан'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Информация о рейсе</h6>
                        <p><strong>Рейс:</strong> ${data.flight_number}</p>
                        <p><strong>Маршрут:</strong> ${data.departure_city} → ${data.arrival_city}</p>
                        <p><strong>Дата вылета:</strong> ${data.departure_time}</p>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Детали бронирования</h6>
                        <p><strong>Класс:</strong> ${data.seat_class}</p>
                        <p><strong>Место:</strong> ${data.seat_number || 'Не назначено'}</p>
                        <p><strong>Багаж:</strong> ${data.baggage_count} место</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Финансы</h6>
                        <p><strong>Цена:</strong> ${data.price_paid} ₽</p>
                        <p><strong>Статус:</strong> ${data.status}</p>
                        <p><strong>Дата бронирования:</strong> ${data.booking_date}</p>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            document.getElementById('bookingDetailsContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Ошибка загрузки деталей бронирования
                </div>
            `;
        });
}



</script>
{% endblock %}
