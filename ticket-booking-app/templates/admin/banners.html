{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –±–∞–Ω–Ω–µ—Ä–∞–º–∏{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-ad"></i> –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –±–∞–Ω–Ω–µ—Ä–∞–º–∏</h2>
                    <small class="text-muted">–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–ª–∞–º–Ω—ã–º–∏ –±–∞–Ω–Ω–µ—Ä–∞–º–∏ –Ω–∞ —Å–∞–π—Ç–µ</small>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-info" onclick="refreshPage()" title="–û–±–Ω–æ–≤–∏—Ç—å">
                        <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBannerModal">
                        <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                    </button>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ total_banners }}</h4>
                                    <span>–í—Å–µ–≥–æ –±–∞–Ω–Ω–µ—Ä–æ–≤</span>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-ad fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ active_banners }}</h4>
                                    <span>–ê–∫—Ç–∏–≤–Ω—ã—Ö</span>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-eye fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ "{:,}".format(total_views) }}</h4>
                                    <span>–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤</span>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>{{ "{:,}".format(total_clicks) }}</h4>
                                    <span>–ö–ª–∏–∫–æ–≤</span>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-mouse-pointer fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –¢–∞–±–ª–∏—Ü–∞ –±–∞–Ω–Ω–µ—Ä–æ–≤ -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-table"></i> –°–ø–∏—Å–æ–∫ –±–∞–Ω–Ω–µ—Ä–æ–≤</h5>
                </div>
                <div class="card-body">
                    {% if banners %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>–ü—Ä–µ–≤—å—é</th>
                                        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
                                        <th>–ü–æ–∑–∏—Ü–∏—è</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</th>
                                        <th>–ü–µ—Ä–∏–æ–¥ –ø–æ–∫–∞–∑–∞</th>
                                        <th>–°–æ–∑–¥–∞–Ω</th>
                                        <th class="text-center">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for banner in banners %}
                                        <tr id="banner-{{ banner.id }}">
                                            <td>
                                                <img src="{{ banner.image_url }}" alt="{{ banner.title }}" 
                                                     class="img-thumbnail" style="max-width: 100px; max-height: 60px;">
                                            </td>
                                            <td>
                                                <div>
                                                    <strong>{{ banner.title }}</strong>
                                                    {% if banner.description %}
                                                        <br><small class="text-muted">{{ banner.description[:80] }}{% if banner.description|length > 80 %}...{% endif %}</small>
                                                    {% endif %}
                                                    <br><small class="text-info">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ banner.priority }}</small>
                                                </div>
                                            </td>
                                            <td>
                                                <span class="badge bg-secondary">{{ banner.position }}</span>
                                            </td>
                                            <td>
                                                {% if banner.is_currently_active() %}
                                                    <span class="badge bg-success">
                                                        <i class="fas fa-eye"></i> –ê–∫—Ç–∏–≤–µ–Ω
                                                    </span>
                                                {% elif banner.is_active %}
                                                    <span class="badge bg-warning">
                                                        <i class="fas fa-clock"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-danger">
                                                        <i class="fas fa-eye-slash"></i> –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small>
                                                    üëÅÔ∏è {{ "{:,}".format(banner.views_count) }}<br>
                                                    üñ±Ô∏è {{ "{:,}".format(banner.clicks_count) }}<br>
                                                    üìä {{ banner.get_click_rate() }}% CTR
                                                </small>
                                            </td>
                                            <td>
                                                <small>
                                                    {% if banner.start_date %}
                                                        üìÖ –° {{ banner.start_date.strftime('%d.%m.%Y %H:%M') }}<br>
                                                    {% endif %}
                                                    {% if banner.end_date %}
                                                        ‚è∞ –î–æ {{ banner.end_date.strftime('%d.%m.%Y %H:%M') }}
                                                    {% endif %}
                                                    {% if not banner.start_date and not banner.end_date %}
                                                        <span class="text-muted">–ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π</span>
                                                    {% endif %}
                                                </small>
                                            </td>
                                            <td>
                                                <small>
                                                    {{ banner.created_at.strftime('%d.%m.%Y') }}<br>
                                                    {% if banner.creator %}
                                                        <span class="text-muted">{{ banner.creator.username }}</span>
                                                    {% endif %}
                                                </small>
                                            </td>
                                            <td class="text-center">
                                                <div class="btn-group" role="group">
                                                    <button class="btn btn-sm btn-outline-primary" 
                                                            onclick="editBanner({{ banner.id }})" 
                                                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <form method="POST" action="{{ url_for('toggle_banner', banner_id=banner.id) }}" style="display: inline;">
                                                        <button type="submit" class="btn btn-sm btn-outline-{{ 'warning' if banner.is_active else 'success' }}" 
                                                                title="{{ '–î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' if banner.is_active else '–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' }}">
                                                            <i class="fas fa-{{ 'eye-slash' if banner.is_active else 'eye' }}"></i>
                                                        </button>
                                                    </form>
                                                    <button class="btn btn-sm btn-outline-danger" 
                                                            onclick="deleteBanner({{ banner.id }}, '{{ banner.title }}')" 
                                                            title="–£–¥–∞–ª–∏—Ç—å">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-ad fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">–ë–∞–Ω–Ω–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                            <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä</p>
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createBannerModal">
                                <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞ -->
<div class="modal fade" id="createBannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —Ä–µ–∫–ª–∞–º–Ω—ã–π –±–∞–Ω–Ω–µ—Ä
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_banner') }}" id="bannerForm">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" required maxlength="200">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="priority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                                <input type="number" class="form-control" id="priority" name="priority" value="0" min="0" max="100">
                                <div class="form-text">–ë–æ–ª—å—à–µ = –≤—ã—à–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="description" name="description" rows="2" maxlength="500"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="image_url" class="form-label">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è <span class="text-danger">*</span></label>
                        <input type="url" class="form-control" id="image_url" name="image_url" required>
                        <div class="form-text">–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="link_url" class="form-label">–°—Å—ã–ª–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ</label>
                        <input type="url" class="form-control" id="link_url" name="link_url">
                        <div class="form-text">URL, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏ –∫–ª–∏–∫–µ</div>
                    </div>
                    
                    <input type="hidden" name="position" value="sidebar">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞</label>
                                <input type="datetime-local" class="form-control" id="start_date" name="start_date">
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞</label>
                                <input type="datetime-local" class="form-control" id="end_date" name="end_date">
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>–ü–æ–¥—Å–∫–∞–∑–∫–∞:</strong> –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏: <strong>300x400 –ø–∏–∫—Å–µ–ª–µ–π</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> –°–æ–∑–¥–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞ -->
<div class="modal fade" id="editBannerModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" id="editBannerForm">
                <div class="modal-body">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–æ —á–µ—Ä–µ–∑ JavaScript -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
function refreshPage() {
    const refreshBtn = document.querySelector('[onclick="refreshPage()"]');
    const originalHtml = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...';
    refreshBtn.disabled = true;
    
    setTimeout(() => {
        location.reload();
    }, 500);
}

// –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞
function editBanner(bannerId) {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
    const row = document.getElementById(`banner-${bannerId}`);
    const banners = [
        {% for banner in banners %}
        {{ banner.to_dict() | tojson }}{% if not loop.last %},{% endif %}
        {% endfor %}
    ];
    const banner = banners.find(b => b.id === bannerId);
    
    if (!banner) {
        alert('–ë–∞–Ω–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    const editForm = document.getElementById('editBannerForm');
    editForm.action = `/admin/banner/edit/${bannerId}`;
    
    const modalBody = editForm.querySelector('.modal-body');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-8">
                <div class="mb-3">
                    <label for="edit_title" class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫ <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="edit_title" name="title" required maxlength="200" value="${banner.title}">
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="edit_priority" class="form-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
                    <input type="number" class="form-control" id="edit_priority" name="priority" value="${banner.priority}" min="0" max="100">
                </div>
            </div>
        </div>
        
        <div class="mb-3">
            <label for="edit_description" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea class="form-control" id="edit_description" name="description" rows="2" maxlength="500">${banner.description || ''}</textarea>
        </div>
        
        <div class="mb-3">
            <label for="edit_image_url" class="form-label">URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è <span class="text-danger">*</span></label>
            <input type="url" class="form-control" id="edit_image_url" name="image_url" required value="${banner.image_url}">
        </div>
        
        <div class="mb-3">
            <label for="edit_link_url" class="form-label">–°—Å—ã–ª–∫–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ</label>
            <input type="url" class="form-control" id="edit_link_url" name="link_url" value="${banner.link_url || ''}">
        </div>
        
        <input type="hidden" name="position" value="sidebar">
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="edit_start_date" class="form-label">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –ø–æ–∫–∞–∑–∞</label>
                    <input type="datetime-local" class="form-control" id="edit_start_date" name="start_date" value="${banner.start_date ? new Date(banner.start_date).toISOString().slice(0, 16) : ''}">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="edit_end_date" class="form-label">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∫–∞–∑–∞</label>
                    <input type="datetime-local" class="form-control" id="edit_end_date" name="end_date" value="${banner.end_date ? new Date(banner.end_date).toISOString().slice(0, 16) : ''}">
                </div>
            </div>
        </div>
    `;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('editBannerModal'));
    modal.show();
}

// –£–¥–∞–ª–µ–Ω–∏–µ –±–∞–Ω–Ω–µ—Ä–∞
function deleteBanner(bannerId, bannerTitle) {
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –±–∞–Ω–Ω–µ—Ä "${bannerTitle}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/banner/delete/${bannerId}`;
        form.style.display = 'none';
        
        document.body.appendChild(form);
        form.submit();
    }
}

// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
document.addEventListener('DOMContentLoaded', function() {
    const bannerForm = document.getElementById('bannerForm');
    
    if (bannerForm) {
        bannerForm.addEventListener('submit', function(e) {
            const title = document.getElementById('title').value.trim();
            const imageUrl = document.getElementById('image_url').value.trim();
            const startDate = document.getElementById('start_date').value;
            const endDate = document.getElementById('end_date').value;
            
            if (!title || !imageUrl) {
                e.preventDefault();
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
                return false;
            }
            
            if (startDate && endDate && new Date(startDate) >= new Date(endDate)) {
                e.preventDefault();
                alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ä–∞–Ω—å—à–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
                return false;
            }
        });
    }
    
    // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('createBannerModal').addEventListener('hidden.bs.modal', function() {
        document.getElementById('bannerForm').reset();
    });
});
</script>
{% endblock %}