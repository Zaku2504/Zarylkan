{% extends "admin/base.html" %}

{% block title %}Управление аэропортами - Админ панель{% endblock %}

{% block admin_content %}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-building"></i> Управление аэропортами</h2>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAirportModal">
                    <i class="fas fa-plus"></i> Добавить аэропорт
                </button>
            </div>
            
            {% if airports %}
                <div class="row">
                    {% for airport in airports %}
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <h5 class="card-title mb-0">{{ airport.name }}</h5>
                                    <span class="badge bg-primary">{{ airport.code }}</span>
                                </div>
                                
                                <div class="mb-2">
                                    <i class="fas fa-map-marker-alt text-muted"></i>
                                    <strong>{{ airport.city }}</strong>, {{ airport.country }}
                                </div>
                                
                                <div class="mb-3">
                                    <small class="text-muted">
                                        <i class="fas fa-plane-departure"></i> 
                                        Исходящих рейсов: {{ airport.departure_flights|length }}
                                    </small>
                                    <br>
                                    <small class="text-muted">
                                        <i class="fas fa-plane-arrival"></i> 
                                        Входящих рейсов: {{ airport.arrival_flights|length }}
                                    </small>
                                </div>
                                
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteAirport({{ airport.id }}, '{{ airport.name }}')">
                                        <i class="fas fa-trash"></i> Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-5">
                    <div class="card bg-light">
                        <div class="card-body py-5">
                            <i class="fas fa-building fa-3x text-muted mb-4"></i>
                            <h4 class="text-muted">Аэропорты не найдены</h4>
                            <p class="text-muted">Добавьте первый аэропорт для начала работы</p>
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAirportModal">
                                <i class="fas fa-plus"></i> Добавить аэропорт
                            </button>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Модальное окно для добавления аэропорта -->
<div class="modal fade" id="addAirportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить новый аэропорт</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addAirportForm">
                    <div class="mb-3">
                        <label class="form-label">IATA код <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="code" maxlength="3" placeholder="SVO" required>
                        <div class="form-text">Трехбуквенный код аэропорта (например: SVO, LED, AER)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Название аэропорта <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" placeholder="Шереметьево" required>
                        <div class="form-text">Полное официальное название аэропорта</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Город <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="city" placeholder="Москва" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Страна <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="country" placeholder="Россия" required>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Важно:</strong> IATA код должен быть уникальным и состоять из 3 латинских букв.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Отмена
                </button>
                <button type="button" class="btn btn-primary" onclick="addAirport()" id="addAirportBtn">
                    <i class="fas fa-plus"></i> Добавить аэропорт
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function addAirport() {
    const form = document.getElementById('addAirportForm');
    const formData = new FormData(form);
    const submitBtn = document.getElementById('addAirportBtn');
    
    // Валидация на клиенте
    const code = formData.get('code').trim();
    const name = formData.get('name').trim();
    const city = formData.get('city').trim();
    const country = formData.get('country').trim();
    
    if (!code || !name || !city || !country) {
        alert('Все поля обязательны для заполнения!');
        return;
    }
    
    if (code.length !== 3) {
        alert('IATA код должен состоять из 3 букв!');
        return;
    }
    
    // Показать индикатор загрузки
    const originalBtnContent = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Добавление...';
    submitBtn.disabled = true;
    
    // Создаем форму для отправки POST запроса
    const submitForm = document.createElement('form');
    submitForm.method = 'POST';
    submitForm.action = '/admin/add_airport';
    submitForm.style.display = 'none';
    
    // Добавляем поля формы
    const fields = ['code', 'name', 'city', 'country'];
    fields.forEach(fieldName => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = fieldName;
        input.value = formData.get(fieldName);
        submitForm.appendChild(input);
    });
    
    document.body.appendChild(submitForm);
    
    // Небольшая задержка для показа индикатора
    setTimeout(() => {
        submitForm.submit();
    }, 500);
}


function deleteAirport(airportId, airportName) {
    if (confirm(`Вы уверены, что хотите удалить аэропорт "${airportName}"?\n\nВнимание: Если с этим аэропортом связаны рейсы, удаление будет невозможно.`)) {
        // Создаем форму для POST запроса
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/admin/delete_airport/${airportId}`;
        form.style.display = 'none';
        
        document.body.appendChild(form);
        form.submit();
    }
}

// Автоматическое преобразование кода аэропорта в верхний регистр
document.addEventListener('DOMContentLoaded', function() {
    const codeInput = document.querySelector('input[name="code"]');
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase().replace(/[^A-Z]/g, '');
            if (this.value.length > 3) {
                this.value = this.value.substring(0, 3);
            }
        });
    }
    
    // Валидация в реальном времени
    const nameInput = document.querySelector('input[name="name"]');
    const cityInput = document.querySelector('input[name="city"]');
    const countryInput = document.querySelector('input[name="country"]');
    
    [nameInput, cityInput, countryInput].forEach(input => {
        if (input) {
            input.addEventListener('input', function() {
                // Капитализация первой буквы
                if (this.value.length > 0) {
                    this.value = this.value.charAt(0).toUpperCase() + this.value.slice(1);
                }
            });
        }
    });
    
    // Сброс формы при закрытии модального окна
    const modal = document.getElementById('addAirportModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('addAirportForm').reset();
        });
    }
});
</script>
{% endblock %}